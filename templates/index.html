<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormalFlow</title>
    <style>
        .container {
            margin-bottom: 20px;
        }
        .output {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            min-height: 100px;
            white-space: pre-wrap;
        }
        .reference-section, .recipient-section {
            display: none;
            margin-top: 20px;
        }
        .reference-section input, .recipient-section input {
            margin-bottom: 10px;
        }
        .reference-entry {
            margin-bottom: 10px;
            position: relative;
        }
        .reference-entry button {
            position: absolute;
            right: 0;
            top: 0;
        }
        .hidden {
            display: none;
        }
        .collapsible {
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 16px;
            background-color: #f1f1f1;
        }

        .synonym-popup {
            position: absolute;
            border: 1px solid #ccc;
            background-color: #fff;
            padding: 10px;
            z-index: 1000;
        }
        .autocomplete-suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            position: absolute;
            z-index: 1000;
            width: calc(100% - 22px);
        }
        .autocomplete-suggestions div {
            padding: 10px;
            cursor: pointer;
        }
        .autocomplete-suggestions div:hover {
            background-color: #f0f0f0;
        }
        .input-group {
            display: flex;
            align-items: center;
            position: relative;
        }
        .input-group input[type="text"] {
            flex-grow: 1;
        }
        .input-group button {
            margin-left: 10px;
            padding: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>FormalFlow</h1>

    <div class="container">
        <h2>Type of Writing</h2>
        <form id="checkbox-form">
            <label><input type="checkbox" name="writingType" value="email"> Email</label><br>
            <label><input type="checkbox" name="writingType" value="scientific-article"> Scientific Article</label>
        </form>
    </div>

    <div class="container recipient-section" id="recipient-section">
        <h2>Recipient Details</h2>
        <label for="recipientName">Recipient Name:</label>
        <input type="text" id="recipientName" name="recipientName"><br><br>

        <label for="emailSubject">Subject:</label>
        <input type="text" id="emailSubject" name="emailSubject"><br><br>

        <div id="email-sender-section" class="hidden">
            <label for="senderName">Sender Name:</label>
            <input type="text" id="senderName" name="senderName"><br><br>
        </div>
    </div>

    <div class="container">
        <h2>Input Details</h2>
        <form id="input-form">
            <div id="reference-section" class="reference-section">
                <button type="button" class="collapsible">Reference Details</button>
                <div class="content">
                    <div id="references-container"></div>
                    <button type="button" id="add-reference-btn">Add Reference</button><br><br>

                    <label for="referenceFormat">Reference Format:</label>
                    <select id="referenceFormat" name="referenceFormat">
                        <option value="apa">APA</option>
                        <option value="mla">MLA</option>
                        <option value="ieee">IEEE</option>
                    </select><br><br>
                </div>
            </div>

            <button type="button" onclick="generateText()">Submit</button>
        </form>
    </div>

    <div id="output" class="output" contenteditable="true"></div>

    <script>
        document.querySelectorAll('#checkbox-form input[type="checkbox"]').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    document.querySelectorAll('#checkbox-form input[type="checkbox"]').forEach(function(otherCheckbox) {
                        if (otherCheckbox !== checkbox) {
                            otherCheckbox.checked = false;
                        }
                    });
                }

                const recipientSection = document.getElementById('recipient-section');
                const referenceSection = document.getElementById('reference-section');
                const emailSenderSection = document.getElementById('email-sender-section');

                if (this.value === 'scientific-article') {
                    recipientSection.style.display = 'none';
                    referenceSection.style.display = 'block';
                    emailSenderSection.classList.add('hidden');
                } else if (this.value === 'email') {
                    recipientSection.style.display = 'block';
                    referenceSection.style.display = 'none';
                    emailSenderSection.classList.remove('hidden');
                } else {
                    recipientSection.style.display = 'none';
                    referenceSection.style.display = 'none';
                    emailSenderSection.classList.add('hidden');
                }
            });
        });



        document.getElementById('add-reference-btn').addEventListener('click', function() {
            const container = document.getElementById('references-container');
            const index = container.children.length + 1;

            const referenceEntry = document.createElement('div');
            referenceEntry.classList.add('reference-entry');
            referenceEntry.innerHTML = `
                <h4>Reference ${index}</h4>
                <div class="input-group">
                    <label for="referenceTitle${index}">Title of Book:</label>
                    <input type="text" id="referenceTitle${index}" name="referenceTitle${index}" autocomplete="off">
                    <button type="button" data-index="${index}">Search</button>
                </div>
                <div id="autocomplete-list${index}" class="autocomplete-suggestions"></div><br><br>

                <label for="referenceAuthor${index}">Author:</label>
                <input type="text" id="referenceAuthor${index}" name="referenceAuthor${index}" readonly><br><br>

                <label for="referenceYear${index}">Year of Publication:</label>
                <input type="text" id="referenceYear${index}" name="referenceYear${index}" readonly><br><br>

                <label for="referencePublisher${index}">Publisher:</label>
                <input type="text" id="referencePublisher${index}" name="referencePublisher${index}" readonly><br><br>

                <button type="button" onclick="removeReference(this)">Remove</button>
            `;
            container.appendChild(referenceEntry);

            // Attach search functionality to newly added buttons
            referenceEntry.querySelector('button[data-index]').addEventListener('click', function() {
                manualSearch(this.dataset.index);
            });
        });

        function removeReference(button) {
            const referenceEntry = button.parentElement;
            referenceEntry.remove();
        }

        async function fetchBookSuggestions(query, inputId) {
            const listId = `autocomplete-list${inputId}`;
            const suggestionList = document.getElementById(listId);
            suggestionList.innerHTML = '';  // Clear previous suggestions
        
            if (query.length < 3) {
                return; // Avoid making API calls for very short inputs
            }
        
            try {
                // Fetch data from Open Library API
                const response = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                const books = data.docs.slice(0, 10); // Get the first 10 results
        
                // Display suggestions
                books.forEach(book => {
                    const title = book.title || 'Unknown title';
                    const author = (book.author_name && book.author_name.length > 0) ? book.author_name[0] : 'Unknown author';
                    const year = book.first_publish_year || 'Unknown year';
                    const publisher = (book.publisher && book.publisher.length > 0) ? book.publisher.join(', ') : 'Unknown publisher'; // Join multiple publishers
        
                    // Check if the query is a substring of title
                    if (title.toLowerCase().includes(query.toLowerCase())) {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.innerHTML = `<strong>${title}</strong> by ${author} (${year}) - ${publisher}`;
                        suggestionItem.onclick = function() {
                            document.getElementById(`referenceTitle${inputId}`).value = title;
                            document.getElementById(`referenceAuthor${inputId}`).value = author;
                            document.getElementById(`referenceYear${inputId}`).value = year;
                            document.getElementById(`referencePublisher${inputId}`).value = publisher; // Set publisher value
                            suggestionList.innerHTML = '';  // Clear suggestions after selection
                            suggestionList.style.display = 'none'; // Hide the suggestions list
                        };
                        suggestionList.appendChild(suggestionItem);
                    }
                });
            } catch (error) {
                console.error('Error fetching book data:', error);
            }
        }
        
        function manualSearch(id) {
            const input = document.getElementById(`referenceTitle${id}`);
            const query = input.value;
            const suggestionList = document.getElementById(`autocomplete-list${id}`);
            suggestionList.style.display = 'block'; // Show the suggestions list
            fetchBookSuggestions(query, id);  // Trigger search using the current input value
        }
        



        async function fetchEmailTemplate(subject) {
            const response = await fetch(`/generate-email-template`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subject: subject })
            });

            if (response.ok) {
                const data = await response.json();
                return data.email;
            } else {
                console.error('Error fetching email template');
            }
        }

        function formatAuthorName(name) {
            const nameParts = name.split(' ');
            
            if (nameParts.length === 0) {
                return '';
            }
            
            // If there's only one part, return it as is
            if (nameParts.length === 1) {
                return nameParts[0];
            }
            
            // Process first and middle names
            const initials = nameParts.slice(0, -1).map(n => n.charAt(0).toUpperCase() + '.').join(' ');
            
            // The last name remains unchanged
            const lastName = nameParts[nameParts.length - 1];
            
            return `${initials} ${lastName}`;
        }
        
        async function generateText() {
            const selectedType = document.querySelector('#checkbox-form input[type="checkbox"]:checked');
            const subject = document.getElementById('emailSubject').value.trim();
            const recipientName = document.getElementById('recipientName').value.trim();
            const senderName = document.getElementById('senderName').value.trim();
            const referenceFormat = document.getElementById('referenceFormat').value;
            const references = document.querySelectorAll('#references-container .reference-entry');
        
            if (!selectedType) {
                alert('Please select a type of writing.');
                return;
            }
        
            const type = selectedType.value;
            let outputText = '';
            let missingDetails = false;
        
            switch (type) {
                case 'email':
                    if (!recipientName || !senderName || !subject) {
                        alert('Please fill in all fields for the email.');
                        return;
                    }
        
                    const emailTemplate = await fetchEmailTemplate(subject);
                    outputText = `${emailTemplate}`;
                    break;
                case 'scientific-article':
                    if (references.length === 0) {
                        alert('Please add at least one reference.');
                        return;
                    }
        
                    references.forEach((ref, index) => {
                        const title = ref.querySelector(`input[name="referenceTitle${index + 1}"]`).value.trim();
                        const author = ref.querySelector(`input[name="referenceAuthor${index + 1}"]`).value.trim();
                        const year = ref.querySelector(`input[name="referenceYear${index + 1}"]`).value.trim();
                        const publisher = ref.querySelector(`input[name="referencePublisher${index + 1}"]`).value.trim();
        
                        if (!title || !author || !year || !publisher) {
                            missingDetails = true;
                        }
        
                        switch (referenceFormat) {
                            case 'apa':
                                outputText += `${formatAuthorName(author)} (${year}). *${title}*. ${publisher}.\n\n`;
                                break;
                            case 'mla':
                                const authorParts = author.split(' ');
                                const formattedAuthor = `${authorParts.slice(-1)}, ${authorParts.slice(0, -1).join(' ')}`;
                                outputText += `${formattedAuthor}. *${title}*. ${publisher}, ${year}.\n\n`;
                                break;
                            case 'ieee':
                                outputText += `[${index + 1}] ${formatAuthorName(author)}, “${title},” ${publisher}, ${year}.\n\n`;
                                break;
                            default:
                                outputText += 'Invalid reference format.\n\n';
                        }
                    });
        
                    if (missingDetails) {
                        alert('Please fill in all details for each reference.');
                        return;
                    }
                    break;
                default:
                    outputText = 'Please select a valid type of writing.';
            }
        
            // Hide all inputs after submission
            document.getElementById('checkbox-form').classList.add('hidden');
            document.getElementById('input-form').classList.add('hidden');
            document.getElementById('output').innerText = outputText;
        }
        

        // Collapsible for reference section
        var coll = document.getElementsByClassName("collapsible");
        for (var i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                } else {
                    content.style.display = "block";
                }
            });
        



        }

        document.addEventListener('mouseup', async function() {
            const selectedText = window.getSelection().toString().trim();
            if (selectedText) {
                const synonyms = await fetchSynonyms(selectedText);
                if (synonyms.length > 0) {
                    showSynonymsPopup(synonyms);
                }
            }
        });

        async function fetchSynonyms(word) {
            const response = await fetch(`/get-synonyms?word=${encodeURIComponent(word)}`);
            if (response.ok) {
                const data = await response.json();
                return data.synonyms;
            } else {
                console.error('Error fetching synonyms');
                return [];
            }
        }

        function showSynonymsPopup(synonyms) {
            const popup = document.createElement('div');
            popup.classList.add('synonym-popup');
            popup.style.left = `${window.event.pageX}px`;
            popup.style.top = `${window.event.pageY}px`;
            popup.innerHTML = `<strong>Synonyms:</strong> ${synonyms.join(', ')}`;
            document.body.appendChild(popup);

            setTimeout(() => popup.remove(), 5000);  // Remove popup after 5 seconds
        }
    </script>
</body>
</html>